from os.path import exists
from os import mkdir
from dataclasses import dataclass

from requests import get

from modules.random_user_agent import random_user_agent


@dataclass
class ExploitInfo:
    Platform : str
    PublishDate : str
    Type : str
    ExploitDBID : int
    Author : str
    Metasploit : bool
    Verified : bool
    Link : str


def GetExploitInfo(CVEID, log):
    try:
        apiresponse = get(
            f"https://www.exploit-db.com/search?cve={CVEID}",
            headers={
                "X-Requested-With": "XMLHttpRequest",
                "User-Agent": next(random_user_agent())
            }
        )
    except ConnectionError:
        log.logger(
            "error",
            "Connection error raised while trying"
            + f" to fetch information about: {CVEID}"
        )
        return []
    else:
        apidata = apiresponse.json()
        ExploitInfos = []
        for exploit in apidata['data']:
            Exploit = ExploitInfo(
                Platform=exploit['platform_id'],
                PublishDate=exploit['date_published'],
                Type=exploit['type_id'],
                ExploitDBID=int(exploit['id']),
                Author=exploit['author']['name'],
                Metasploit=exploit['author']['name'] == "Metasploit",
                Verified=exploit['verified'] == "1",
                Link=f"https://www.exploit-db.com/download/{exploit['id']}"
            )
            ExploitInfos.append(Exploit)

        return ExploitInfos


def GetExploitContents(ExploitLink, log):
    try:
        apiresponse = get(
            ExploitLink,
            headers={
                "X-Requested-With": "XMLHttpRequest",
                "User-Agent": next(random_user_agent())
            }
        )
        content = apiresponse.content
        filename = apiresponse.headers['Content-Disposition'].lstrip(
                "attachment; filename=\""
            )
    except ConnectionError:
        log.logger(
            "error",
            f"Connection error raised while trying to fetch: {ExploitLink}"
        )
        return None, None
    else:
        return content, filename


def GetExploitAsFile(vulnerability, term_width, console):
    SoftwareName = vulnerability.Software
    CVEs = vulnerability.CVEs

    if not exists("exploits"):
        mkdir("exploits")

    printed_software = []
    for CVE in CVEs:
        Exploits = GetExploitInfo(CVE)
        if len(Exploits) < 0:
            continue

        if SoftwareName not in printed_software:
            console.print(f"\n\n┌─[yellow][{SoftwareName}][/yellow]\n│")
            printed_software.append(SoftwareName)

        console.print(f"│\n├─────┤ [red]{str(CVE)}[/red]\n│")

        for exploit in Exploits:
            print(
                f"Downloading exploit(s) for {SoftwareName} ({CVE})...",
                end="\r"
            )
            content, filename = GetExploitContents(exploit.Link)
            if content is None:
                continue

            if not exists(f"exploits/{SoftwareName}"):
                mkdir(f"exploits/{SoftwareName}")

            if not exists(f"exploits/{SoftwareName}/{CVE}"):
                mkdir(f"exploits/{SoftwareName}/{CVE}")

            with open(
                    f"exploits/{SoftwareName}/{CVE}/{filename}", "wb"
                ) as exploitfile:
                print(" " * term_width, end="\r") #clear the line
                console.print(
                    f"├──────────# exploits/{SoftwareName}/{CVE}/{filename}\n│"
                    + f"│\t\t [cyan]Platform: [/cyan] {exploit.Platform}\n"
                    + f"│\t\t [cyan]Type: [/cyan] {exploit.Type}\n"
                    + f"│\t\t [cyan]Author: [/cyan] {exploit.Author}\n"
                    + f"│\t\t [cyan]Date: [/cyan] {exploit.PublishDate}\n"
                    + f"│\t\t [cyan]Metasploit: [/cyan] {exploit.Metasploit}\n"
                    + f"│\t\t [cyan]Verified: [/cyan]{exploit.Verified}\n"
                    + f"│\t\t [cyan]Link: [/cyan] {exploit.Link}\n│"
                )
                exploitfile.write(content)

    if SoftwareName in printed_software:
        print("└" + "─" * (term_width-1) + "\n")


def GetExploitsFromArray(VulnsArray, console, target=None):
    if target:
        console.print(f"Downloading exploits for {target}...", style="blue")
    else:
        console.print(f"Downloading exploits...", style="blue")

    for vulnerability in VulnsArray:
        GetExploitAsFile(vulnerability)
